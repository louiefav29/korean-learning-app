<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Korean Learning Hub</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      :root {
        --card-bg: #1a1a1a;
        --card-border: #333;
        --header-color: #fff;
        --text-primary: #fff;
        --text-secondary: #ccc;
        --btn-bg: #2a2a2a;
        --btn-bg-hover: #3a3a3a;
        --shadow-color: rgba(0, 0, 0, 0.3);
      }

      .light-mode {
        --card-bg: #fff;
        --card-border: #e1e5e9;
        --header-color: #2c3e50;
        --text-primary: #333;
        --text-secondary: #5a6c7d;
        --btn-bg: #f8f9fa;
        --btn-bg-hover: #e9ecef;
        --shadow-color: rgba(0, 0, 0, 0.1);
      }

      .reset-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
      }
      .reset-card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px var(--shadow-color),
          0 10px 10px -5px var(--shadow-color);
        max-width: 400px;
        width: 100%;
        text-align: center;
      }
      .reset-card h1 {
        color: var(--header-color);
        margin-bottom: 1rem;
        font-size: 1.8rem;
      }
      .reset-card p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }
      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--card-border);
        border-radius: 0.5rem;
        background-color: var(--btn-bg);
        color: var(--text-primary);
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      .form-group input:focus {
        outline: none;
        border-color: var(--header-color);
      }
      .btn-reset {
        width: 100%;
        padding: 0.75rem;
        background-color: #9333ea;
        color: #ffffff;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        box-shadow: 0 4px 6px -1px var(--shadow-color),
          0 2px 4px -1px var(--shadow-color);
      }
      .btn-reset:hover {
        background-color: #7e22ce;
      }
      .btn-reset:disabled {
        background-color: #6b7280;
        cursor: not-allowed;
      }
      .back-link {
        margin-top: 1.5rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }
      .back-link a {
        color: var(--header-color);
        text-decoration: none;
        font-weight: 500;
      }
      .back-link a:hover {
        text-decoration: underline;
      }
      .error-message {
        color: #ef4444;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      .success-message {
        color: #10b981;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      .countdown {
        color: #f59e0b;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="reset-container">
      <div class="reset-card">
        <h1>Reset Password</h1>
        <p>
          Enter your email address and we'll send you a link to reset your
          password.
        </p>

        <form id="resetForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              required
              placeholder="Enter your email"
            />
          </div>

          <button type="submit" class="btn-reset" id="resetButton">
            Send Reset Link
          </button>

          <div
            id="errorMessage"
            class="error-message"
            style="display: none"
          ></div>
          <div
            id="successMessage"
            class="success-message"
            style="display: none"
          ></div>
          <div id="countdown" class="countdown" style="display: none"></div>
        </form>

        <div class="back-link">
          <a href="login.html">← Back to Login</a>
        </div>
      </div>
    </div>

    <!-- Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
      let countdownInterval;
      let isCountdownActive = false;

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        const successDiv = document.getElementById("successMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        successDiv.style.display = "none";
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMessage");
        const errorDiv = document.getElementById("errorMessage");
        successDiv.textContent = message;
        successDiv.style.display = "block";
        errorDiv.style.display = "none";
      }

      function hideMessages() {
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("successMessage").style.display = "none";
        document.getElementById("countdown").style.display = "none";
      }

      function startCountdown(seconds) {
        const countdownDiv = document.getElementById("countdown");
        const resetButton = document.getElementById("resetButton");

        isCountdownActive = true;
        resetButton.disabled = true;
        resetButton.textContent = `Please wait ${seconds}s`;

        let remainingTime = seconds;
        countdownDiv.style.display = "block";

        countdownInterval = setInterval(() => {
          remainingTime--;
          if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            isCountdownActive = false;
            resetButton.disabled = false;
            resetButton.textContent = "Send Reset Link";
            countdownDiv.style.display = "none";
          } else {
            resetButton.textContent = `Please wait ${remainingTime}s`;
          }
        }, 1000);
      }

      // Handle form submission
      document
        .getElementById("resetForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          hideMessages();

          const email = document.getElementById("email").value;

          // Validate email format
          if (!email || !email.includes("@")) {
            showError("Please enter a valid email address.");
            return;
          }

          // Check if already in countdown
          if (isCountdownActive) {
            showError(
              "Please wait for the countdown to finish before requesting another reset."
            );
            return;
          }

          // Check if Supabase is available
          if (!window.supabaseClient) {
            showError(
              "Service not available. Please check your connection and refresh."
            );
            return;
          }

          // Show loading state
          const resetButton = document.getElementById("resetButton");
          const originalText = resetButton.textContent;
          resetButton.textContent = "Sending...";
          resetButton.disabled = true;

          try {
            console.log("Sending password reset to:", email);
            const { data, error } =
              await window.supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + "/reset-password.html",
              });

            if (error) {
              console.error("Password reset error:", error);

              // Handle specific rate limiting error
              if (error.message.includes("you can only request this after")) {
                const match = error.message.match(/after (\d+) seconds/);
                const waitTime = match ? parseInt(match[1]) : 30;
                showError(
                  `Too many requests. Please wait ${waitTime} seconds before trying again.`
                );
                startCountdown(waitTime);
              } else if (error.message.includes("User not found")) {
                showError(
                  "If this email exists in our system, you will receive a reset link."
                );
                // Don't reveal if email exists or not for security
                startCountdown(30);
              } else {
                showError("Failed to send reset link: " + error.message);
                resetButton.textContent = originalText;
                resetButton.disabled = false;
              }
            } else {
              console.log("Password reset email sent successfully");
              showSuccess(
                "Password reset link sent! Please check your email (including spam folder)."
              );
              startCountdown(30); // Prevent spam
            }
          } catch (error) {
            console.error("Unexpected error:", error);
            showError("An unexpected error occurred. Please try again.");
            resetButton.textContent = originalText;
            resetButton.disabled = false;
          }
        });

      // Handle password reset from email link
      async function handlePasswordReset() {
        const hashParams = new URLSearchParams(
          window.location.hash.substring(1)
        );
        const accessToken = hashParams.get("access_token");
        const refreshToken = hashParams.get("refresh_token");
        const type = hashParams.get("type");

        if (accessToken && type === "recovery") {
          try {
            // Set the session using the tokens from URL
            const { data, error } = await window.supabaseClient.auth.setSession(
              {
                access_token: accessToken,
                refresh_token: refreshToken,
              }
            );

            if (error) throw error;

            // Show password update form
            showPasswordUpdateForm();
          } catch (error) {
            console.error("Error handling password reset:", error);
            showError(
              "Invalid or expired reset link. Please request a new one."
            );
          }
        }
      }

      function showPasswordUpdateForm() {
        const resetCard = document.querySelector(".reset-card");
        resetCard.innerHTML = `
          <h1>Update Password</h1>
          <p>Enter your new password below.</p>
          
          <form id="updateForm">
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" required placeholder="Enter new password" minlength="6" />
            </div>
            
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <input type="password" id="confirmPassword" required placeholder="Confirm new password" />
            </div>
            
            <button type="submit" class="btn-reset">Update Password</button>
            
            <div id="updateErrorMessage" class="error-message" style="display: none"></div>
            <div id="updateSuccessMessage" class="success-message" style="display: none"></div>
          </form>
          
          <div class="back-link">
            <a href="login.html">← Back to Login</a>
          </div>
        `;

        // Add update form handler
        document
          .getElementById("updateForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();

            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;

            if (newPassword.length < 6) {
              document.getElementById("updateErrorMessage").textContent =
                "Password must be at least 6 characters long.";
              document.getElementById("updateErrorMessage").style.display =
                "block";
              return;
            }

            if (newPassword !== confirmPassword) {
              document.getElementById("updateErrorMessage").textContent =
                "Passwords do not match.";
              document.getElementById("updateErrorMessage").style.display =
                "block";
              return;
            }

            const updateButton = event.target.querySelector(".btn-reset");
            const originalText = updateButton.textContent;
            updateButton.textContent = "Updating...";
            updateButton.disabled = true;

            try {
              const { data, error } =
                await window.supabaseClient.auth.updateUser({
                  password: newPassword,
                });

              if (error) throw error;

              document.getElementById("updateSuccessMessage").textContent =
                "Password updated successfully! Redirecting to login...";
              document.getElementById("updateSuccessMessage").style.display =
                "block";

              setTimeout(() => {
                window.location.href = "login.html";
              }, 2000);
            } catch (error) {
              console.error("Password update error:", error);
              document.getElementById("updateErrorMessage").textContent =
                "Failed to update password: " + error.message;
              document.getElementById("updateErrorMessage").style.display =
                "block";
              updateButton.textContent = originalText;
              updateButton.disabled = false;
            }
          });
      }

      // Check for password reset on page load
      document.addEventListener("DOMContentLoaded", () => {
        handlePasswordReset();
      });
    </script>
  </body>
</html>
